{% extends "base.html" %}

{% block header %}
<header class="tg-header">
    <div class="tg-logo">
        <i class="fab fa-telegram tg-logo-icon"></i>
        <span class="tg-logo-text">Telegram Web</span>
    </div>
    <nav class="tg-nav">
        <a href="/logout" class="tg-nav-link">
            <i class="fas fa-sign-out-alt"></i>
            <span>–í—ã–π—Ç–∏</span>
        </a>
    </nav>
</header>
{% endblock %}

{% block content %}
<input type="hidden" id="current-user-id" value="{{ current_user_id }}">
<div class="messenger-app">
    <!-- –°–∞–π–¥–±–∞—Ä —Å–ª–µ–≤–∞ -->
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="user-info">
                <div class="user-avatar">
                    {{ current_user.username[0]|upper }}
                </div>
                <div class="user-details">
                    <h3>{{ current_user.username }}</h3>
                    <p id="connection-status">üî¥ Offline</p>
                </div>
            </div>
        </div>
        
        <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" placeholder="–ü–æ–∏—Å–∫..." oninput="searchUsers(this.value)">
        </div>
        
        <div class="chats-list">
            <div class="chats-title">–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</div>
            
            {% for user in users %}
            {% if user.id != current_user.id %}
            <div class="chat-item" 
                 onclick="openChat('{{ user.id }}', '{{ user.username }}')"
                 id="chat-user-{{ user.id }}">
                <div class="chat-avatar">
                    {{ user.username[0]|upper }}
                </div>
                <div class="chat-info">
                    <h4>{{ user.username }}</h4>
                    <p class="last-message">–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</p>
                </div>
                <div class="chat-status">
                    <div class="status-indicator"></div>
                </div>
            </div>
            {% endif %}
            {% endfor %}
        </div>
    </div>
    
    <!-- –û—Å–Ω–æ–≤–Ω–æ–π —á–∞—Ç –ø–æ —Ü–µ–Ω—Ç—Ä—É -->
    <div class="chat-area">
        <div class="empty-chat" id="empty-chat">
            <div class="empty-chat-icon">
                <i class="fab fa-telegram"></i>
            </div>
            <h2>Telegram Web</h2>
            <p>–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ</p>
            <div class="hint">–°–æ–æ–±—â–µ–Ω–∏—è —à–∏—Ñ—Ä—É—é—Ç—Å—è –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è –º–µ–∂–¥—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏</div>
        </div>
        
        <div id="chat-container" style="display: none; height: 100%;">
            <!-- –ß–∞—Ç –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
        </div>
    </div>
</div>

<style>
/* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —á–∞—Ç–∞ */
.messenger-app {
    display: flex;
    height: calc(100vh - 60px);
    width: 100%;
    background: var(--tg-bg);
}

/* –°–∞–π–¥–±–∞—Ä —Å —á–∞—Ç–∞–º–∏ —Å–ª–µ–≤–∞ */
.sidebar {
    width: 360px;
    background: var(--tg-secondary-bg);
    border-right: 1px solid var(--tg-border);
    display: flex;
    flex-direction: column;
    height: 100%;
    flex-shrink: 0;
}

/* –û—Å–Ω–æ–≤–Ω–æ–π —á–∞—Ç —Å–ø—Ä–∞–≤–∞ */
.chat-area {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: var(--tg-bg);
    position: relative;
    overflow: hidden;
}

/* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —á–∞—Ç–∞ - –∑–∞–Ω–∏–º–∞–µ—Ç –≤—Å—é –≤—ã—Å–æ—Ç—É */
#chat-container {
    display: flex;
    flex-direction: column;
    height: 100%;
    width: 100%;
    background: var(--tg-bg);
}

/* –®–∞–ø–∫–∞ —á–∞—Ç–∞ */
.chat-header {
    height: 60px;
    background: var(--tg-bg);
    border-bottom: 1px solid var(--tg-border);
    display: flex;
    align-items: center;
    padding: 0 20px;
    flex-shrink: 0;
    z-index: 100;
}

/* –û–±–ª–∞—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ —Ü–µ–Ω—Ç—Ä—É */
.chat-messages-container {
    flex: 1;
    overflow-y: auto;
    background: var(--tg-secondary-bg);
    display: flex;
    justify-content: center;
    padding: 0;
}

.chat-messages {
    width: 100%;
    max-width: 800px;
    padding: 20px;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    gap: 12px;
}

/* –°–æ–æ–±—â–µ–Ω–∏—è –ø–æ —Ü–µ–Ω—Ç—Ä—É, –Ω–æ –≤—ã—Ä–æ–≤–Ω–µ–Ω–Ω—ã–µ –ø–æ –∫—Ä–∞—è–º */
.message-container {
    display: flex;
    margin-bottom: 8px;
    animation: fadeIn 0.3s ease;
}

.message-container.sent {
    justify-content: flex-end;
}

.message-container.received {
    justify-content: flex-start;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —Å–∞–º–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π */
.message-bubble {
    max-width: 65%;
    padding: 10px 16px;
    border-radius: 18px;
    word-wrap: break-word;
    position: relative;
    font-size: 14.5px;
    line-height: 1.4;
}

.message-bubble.sent {
    background: var(--tg-blue);
    color: white;
    border-radius: 18px 18px 4px 18px;
}

.message-bubble.received {
    background: white;
    color: var(--tg-text-primary);
    border: 1px solid var(--tg-border);
    border-radius: 18px 18px 18px 4px;
}

.message-time {
    font-size: 11px;
    color: rgba(255, 255, 255, 0.8);
    margin-top: 4px;
    text-align: right;
    opacity: 0.8;
}

.message-bubble.received .message-time {
    color: var(--tg-text-muted);
    text-align: left;
}

/* –ü–æ–ª–µ –≤–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –≤–Ω–∏–∑—É */
.chat-input-container {
    background: var(--tg-bg);
    border-top: 1px solid var(--tg-border);
    padding: 16px 20px;
    flex-shrink: 0;
}

.chat-input-wrapper {
    display: flex;
    align-items: center;
    gap: 12px;
    max-width: 800px;
    margin: 0 auto;
}

.chat-input {
    flex: 1;
    height: 44px;
    padding: 0 20px;
    background: var(--tg-secondary-bg);
    border: 1px solid var(--tg-border);
    border-radius: 22px;
    font-size: 15px;
    color: var(--tg-text-primary);
    outline: none;
    transition: all 0.2s ease;
}

.chat-input:focus {
    background: var(--tg-bg);
    border-color: var(--tg-blue);
    box-shadow: 0 0 0 3px rgba(51, 144, 236, 0.1);
}

.send-button {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: var(--tg-blue);
    color: white;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    flex-shrink: 0;
}

.send-button:hover {
    background: var(--tg-blue-hover);
    transform: scale(1.05);
}

.send-button:disabled {
    background: var(--tg-text-muted);
    cursor: not-allowed;
    transform: none;
}

/* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä "–ø–µ—á–∞—Ç–∞–µ—Ç" */
.typing-indicator {
    padding: 8px 20px;
    font-size: 13px;
    color: var(--tg-text-secondary);
    font-style: italic;
    background: var(--tg-secondary-bg);
    border-radius: 18px;
    display: inline-block;
    margin-bottom: 8px;
}

/* –î–∞—Ç–∞ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å */
.date-divider {
    text-align: center;
    margin: 20px 0;
    position: relative;
}

.date-divider span {
    background: var(--tg-secondary-bg);
    padding: 6px 16px;
    border-radius: 20px;
    font-size: 12px;
    color: var(--tg-text-secondary);
    border: 1px solid var(--tg-border);
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π */
@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* –ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
@media (max-width: 1024px) {
    .sidebar {
        width: 320px;
    }
    
    .chat-messages {
        max-width: 700px;
    }
}

@media (max-width: 768px) {
    .sidebar {
        width: 100%;
        position: absolute;
        z-index: 1000;
        left: 0;
        top: 0;
        height: 100%;
        transform: translateX(-100%);
        transition: transform 0.3s ease;
    }
    
    .sidebar.active {
        transform: translateX(0);
    }
    
    .chat-messages {
        max-width: 100%;
        padding: 15px;
    }
    
    .message-bubble {
        max-width: 80%;
    }
}
</style>

<script>
let currentChatUser = null;
let ws = null;
let currentUserId = null;
let isTyping = false;
let typingTimeout = null;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
document.addEventListener('DOMContentLoaded', function() {
    currentUserId = document.getElementById('current-user-id').value;
    console.log('Current user ID:', currentUserId);
    
    if (currentUserId) {
        connectWebSocket();
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —á–∞—Ç–æ–≤
    const chatItems = document.querySelectorAll('.chat-item');
    chatItems.forEach(item => {
        item.addEventListener('click', function() {
            chatItems.forEach(i => i.classList.remove('active'));
            this.classList.add('active');
            
            // –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö —Å–∫—Ä—ã–≤–∞–µ–º —Å–∞–π–¥–±–∞—Ä –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ —á–∞—Ç–∞
            if (window.innerWidth <= 768) {
                document.querySelector('.sidebar').classList.remove('active');
            }
        });
    });
    
    // –ö–Ω–æ–ø–∫–∞ –º–µ–Ω—é –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
    const menuBtn = document.createElement('button');
    menuBtn.innerHTML = '<i class="fas fa-bars"></i>';
    menuBtn.style.cssText = `
        position: fixed;
        top: 70px;
        left: 15px;
        z-index: 1001;
        background: var(--tg-blue);
        color: white;
        border: none;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: none;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: var(--tg-shadow);
    `;
    menuBtn.addEventListener('click', () => {
        document.querySelector('.sidebar').classList.toggle('active');
    });
    document.body.appendChild(menuBtn);
    
    // –°–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–∞—Ö
    function checkScreenSize() {
        if (window.innerWidth <= 768) {
            menuBtn.style.display = 'flex';
            document.querySelector('.sidebar').classList.remove('active');
        } else {
            menuBtn.style.display = 'none';
            document.querySelector('.sidebar').classList.remove('active');
        }
    }
    
    checkScreenSize();
    window.addEventListener('resize', checkScreenSize);
});

// –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
function searchUsers(query) {
    const chatItems = document.querySelectorAll('.chat-item');
    const normalizedQuery = query.toLowerCase().trim();
    
    chatItems.forEach(item => {
        const username = item.querySelector('h4').textContent.toLowerCase();
        const lastMessage = item.querySelector('.last-message').textContent.toLowerCase();
        
        if (normalizedQuery === '' || username.includes(normalizedQuery) || lastMessage.includes(normalizedQuery)) {
            item.style.display = 'flex';
        } else {
            item.style.display = 'none';
        }
    });
}

// –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ WebSocket
function connectWebSocket() {
    if (!currentUserId || currentUserId === 'None') {
        console.error('Invalid user ID:', currentUserId);
        return;
    }
    
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${protocol}//${window.location.host}/ws/${currentUserId}`;
    
    console.log('Connecting to WebSocket:', wsUrl);
    
    ws = new WebSocket(wsUrl);
    
    ws.onopen = function() {
        console.log('‚úÖ WebSocket connected');
        document.getElementById('connection-status').textContent = 'üü¢ Online';
        showNotification('Connected', 'success');
    };
    
    ws.onmessage = function(event) {
        console.log('WebSocket message:', event.data);
        const data = JSON.parse(event.data);
        
        if (data.type === 'new_message') {
            if (currentChatUser && data.sender_id == currentChatUser.id) {
                addMessageToChat(data.content, false, data.timestamp);
                updateLastMessage(currentChatUser.id, data.content);
                playMessageSound();
            } else {
                // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–æ–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
                showNotification(`–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è`, 'info');
                updateUnreadCount(data.sender_id);
            }
        }
    };
    
    ws.onclose = function() {
        console.log('‚ùå WebSocket disconnected');
        document.getElementById('connection-status').textContent = 'üî¥ Offline';
        setTimeout(connectWebSocket, 3000);
    };
    
    ws.onerror = function(error) {
        console.error('WebSocket error:', error);
    };
}

// –û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç
function openChat(userId, username) {
    currentChatUser = { id: parseInt(userId), username: username };
    
    // –ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —á–∞—Ç–∞
    document.getElementById('empty-chat').style.display = 'none';
    const chatContainer = document.getElementById('chat-container');
    chatContainer.style.display = 'flex';
    
    // –°–æ–∑–¥–∞—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —á–∞—Ç–∞
    chatContainer.innerHTML = `
        <div style="display: flex; flex-direction: column; height: 100%; width: 100%;">
            <!-- –®–∞–ø–∫–∞ —á–∞—Ç–∞ -->
            <div class="chat-header">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <!-- –ê–≤–∞—Ç–∞—Ä -->
                    <div style="
                        width: 40px;
                        height: 40px;
                        background: linear-gradient(135deg, #3390ec, #4dabf7);
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: white;
                        font-weight: 600;
                        font-size: 16px;
                        flex-shrink: 0;
                    ">
                        ${username[0].toUpperCase()}
                    </div>
                    
                    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ -->
                    <div>
                        <h3 style="margin: 0; font-size: 16px; font-weight: 600; color: var(--tg-text-primary);">
                            ${username}
                        </h3>
                        <p style="margin: 0; color: var(--tg-text-secondary); font-size: 13px;" id="chat-status">
                            Online
                        </p>
                    </div>
                </div>
                
                <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∞–Ω–∏—è -->
                <div id="typing-indicator" style="margin-left: auto; display: none;">
                    <div class="typing-indicator">
                        –ø–µ—á–∞—Ç–∞–µ—Ç...
                    </div>
                </div>
            </div>
            
            <!-- –û–±–ª–∞—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–π -->
            <div class="chat-messages-container">
                <div class="chat-messages" id="chat-messages">
                    <div style="text-align: center; padding: 40px; color: var(--tg-text-secondary);">
                        –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...
                    </div>
                </div>
            </div>
            
            <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ -->
            <div class="chat-input-container">
                <div class="chat-input-wrapper">
                    <input type="text" 
                           id="message-input" 
                           placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
                           class="chat-input"
                           oninput="handleTyping()">
                    <button onclick="sendMessage()" class="send-button" id="send-button">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    `;
    
    // –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ Enter
    const input = document.getElementById('message-input');
    input.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
    
    // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è
    loadMessages(userId);
    
    // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
    setTimeout(() => {
        input.focus();
    }, 100);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.title = `${username} ‚Ä¢ Telegram Web`;
}

// –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è
async function loadMessages(userId) {
    try {
        const response = await fetch(`/messages/${userId}`);
        const messages = await response.json();
        
        const container = document.getElementById('chat-messages');
        if (!container) return;
        
        container.innerHTML = '';
        
        if (messages.length === 0) {
            container.innerHTML = `
                <div style="
                    text-align: center; 
                    padding: 60px 20px; 
                    color: var(--tg-text-secondary);
                    flex: 1;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                ">
                    <div style="font-size: 96px; opacity: 0.1; margin-bottom: 20px;">
                        <i class="fab fa-telegram"></i>
                    </div>
                    <h3 style="margin: 0 0 10px 0; color: var(--tg-text-primary);">
                        –ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π
                    </h3>
                    <p style="margin: 0; max-width: 300px;">
                        –ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ, –æ—Ç–ø—Ä–∞–≤–∏–≤ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ!
                    </p>
                </div>
            `;
            return;
        }
        
        let lastDate = null;
        
        messages.forEach(msg => {
            // –î–æ–±–∞–≤–ª—è–µ–º –¥–∞—Ç—É-—Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å
            const msgDate = new Date(msg.created_at).toLocaleDateString();
            if (msgDate !== lastDate) {
                addDateDivider(msg.created_at);
                lastDate = msgDate;
            }
            
            addMessageToChat(msg.content, msg.is_sent, msg.created_at);
        });
        
        // –ü—Ä–æ–∫—Ä—É—Ç–∏—Ç—å –≤–Ω–∏–∑
        setTimeout(() => {
            const messagesContainer = document.querySelector('.chat-messages-container');
            if (messagesContainer) {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        }, 100);
        
    } catch (error) {
        console.error('Error loading messages:', error);
        showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π', 'error');
    }
}

// –î–æ–±–∞–≤–∏—Ç—å –¥–∞—Ç—É-—Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å
function addDateDivider(timestamp) {
    const container = document.getElementById('chat-messages');
    if (!container) return;
    
    const date = new Date(timestamp);
    const today = new Date();
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);
    
    let dateText;
    if (date.toDateString() === today.toDateString()) {
        dateText = '–°–µ–≥–æ–¥–Ω—è';
    } else if (date.toDateString() === yesterday.toDateString()) {
        dateText = '–í—á–µ—Ä–∞';
    } else {
        dateText = date.toLocaleDateString('ru-RU', {
            day: 'numeric',
            month: 'long',
            year: date.getFullYear() !== today.getFullYear() ? 'numeric' : undefined
        });
    }
    
    const divider = document.createElement('div');
    divider.className = 'date-divider';
    divider.innerHTML = `<span>${dateText}</span>`;
    container.appendChild(divider);
}

// –î–æ–±–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç
function addMessageToChat(content, isSent, timestamp) {
    const container = document.getElementById('chat-messages');
    if (!container) return;
    
    // –£–±–∏—Ä–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–≥—Ä—É–∑–∫–µ
    if (container.innerHTML.includes('–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π') || 
        container.innerHTML.includes('–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π')) {
        container.innerHTML = '';
    }
    
    const time = new Date(timestamp).toLocaleTimeString('ru-RU', {
        hour: '2-digit',
        minute: '2-digit'
    });
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `message-container ${isSent ? 'sent' : 'received'}`;
    
    messageDiv.innerHTML = `
        <div class="message-bubble ${isSent ? 'sent' : 'received'}">
            <div>${content}</div>
            <div class="message-time">${time}</div>
        </div>
    `;
    
    container.appendChild(messageDiv);
    
    // –ü—Ä–æ–∫—Ä—É—Ç–∏—Ç—å –≤–Ω–∏–∑
    setTimeout(() => {
        const messagesContainer = document.querySelector('.chat-messages-container');
        if (messagesContainer) {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
    }, 50);
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—á–∞—Ç–∞–Ω–∏—è
function handleTyping() {
    if (!currentChatUser || !ws) return;
    
    if (!isTyping) {
        isTyping = true;
        // –ú–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø–µ—á–∞—Ç–∞–Ω–∏–∏ —á–µ—Ä–µ–∑ WebSocket
        // ws.send(JSON.stringify({
        //     type: 'typing',
        //     receiver_id: currentChatUser.id,
        //     is_typing: true
        // }));
    }
    
    clearTimeout(typingTimeout);
    typingTimeout = setTimeout(() => {
        isTyping = false;
        // ws.send(JSON.stringify({
        //     type: 'typing',
        //     receiver_id: currentChatUser.id,
        //     is_typing: false
        // }));
    }, 1000);
}

// –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
function sendMessage() {
    const input = document.getElementById('message-input');
    const button = document.getElementById('send-button');
    const message = input.value.trim();
    
    if (!message || !currentChatUser) {
        showNotification('–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ', 'warning');
        return;
    }
    
    if (!ws || ws.readyState !== WebSocket.OPEN) {
        showNotification('–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.', 'error');
        return;
    }
    
    // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    
    // –û—Ç–ø—Ä–∞–≤–∏—Ç—å —á–µ—Ä–µ–∑ WebSocket
    ws.send(JSON.stringify({
        type: 'message',
        content: message,
        receiver_id: currentChatUser.id
    }));
    
    // –î–æ–±–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç (–æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ)
    addMessageToChat(message, true, new Date().toISOString());
    updateLastMessage(currentChatUser.id, message);
    
    // –û—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª–µ –≤–≤–æ–¥–∞
    input.value = '';
    input.focus();
    
    // –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–æ–ø–∫—É
    setTimeout(() => {
        button.disabled = false;
        button.innerHTML = '<i class="fas fa-paper-plane"></i>';
    }, 500);
}

// –û–±–Ω–æ–≤–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Å–ø–∏—Å–∫–µ —á–∞—Ç–æ–≤
function updateLastMessage(userId, message) {
    const chatItem = document.getElementById(`chat-user-${userId}`);
    if (chatItem) {
        const lastMsg = chatItem.querySelector('.last-message');
        if (lastMsg) {
            lastMsg.textContent = message.length > 30 ? message.substring(0, 30) + '...' : message;
        }
    }
}

// –û–±–Ω–æ–≤–∏—Ç—å —Å—á–µ—Ç—á–∏–∫ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö
function updateUnreadCount(userId) {
    const chatItem = document.getElementById(`chat-user-${userId}`);
    if (chatItem) {
        let badge = chatItem.querySelector('.unread-badge');
        if (!badge) {
            badge = document.createElement('div');
            badge.className = 'unread-badge';
            badge.textContent = '1';
            chatItem.querySelector('.chat-status').appendChild(badge);
        } else {
            badge.textContent = parseInt(badge.textContent) + 1;
        }
    }
}

// –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 80px;
        right: 20px;
        background: ${type === 'error' ? '#ff3b30' : type === 'success' ? '#32a955' : '#3390ec'};
        color: white;
        padding: 12px 20px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 9999;
        animation: slideIn 0.3s ease;
        max-width: 300px;
        word-wrap: break-word;
    `;
    
    notification.innerHTML = `
        <div style="display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-${type === 'error' ? 'exclamation-circle' : type === 'success' ? 'check-circle' : 'info-circle'}"></i>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

// –ó–≤—É–∫ –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
function playMessageSound() {
    try {
        const audio = new Audio('data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAAAA==');
        audio.volume = 0.3;
        audio.play().catch(e => console.log('Audio play failed:', e));
    } catch (e) {
        console.log('Audio not supported');
    }
}

// –°—Ç–∏–ª–∏ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–π —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes slideOut {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}