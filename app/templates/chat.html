{% extends "base.html" %}

{% block title %}–ß–∞—Ç - Void Messenger{% endblock %}

{% block content %}
<div style="display: flex; height: 90vh; font-family: Arial, sans-serif;">
    
    <!-- –õ–ï–í–ê–Ø –ü–ê–ù–ï–õ–¨: –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ -->
    <div style="width: 30%; border-right: 1px solid #ddd; display: flex; flex-direction: column;">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <div style="padding: 15px; border-bottom: 1px solid #ddd;">
            <h3 style="margin: 0;">–ß–∞—Ç—ã</h3>
            <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">
                –í—ã: <strong id="currentUserDisplay">{{ current_user.username }}</strong>
                <a href="/logout" style="margin-left: 10px; color: #666; font-size: 12px; text-decoration: none;">(–í—ã–π—Ç–∏)</a>
            </p>
        </div>
        
        <!-- –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
        <div id="usersList" style="flex: 1; overflow-y: auto;">
            {% for user in users %}
            <div class="chat-item" 
                 data-user-id="{{ user.id }}"
                 data-user-name="{{ user.username }}"
                 style="padding: 12px 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; display: flex; align-items: center;"
                 onmouseover="this.style.background='#f5f5f5'"
                 onmouseout="if(!this.classList.contains('selected')) this.style.background='white'">
                <div style="width: 40px; height: 40px; background: #007bff; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 10px; font-weight: bold;">
                    {{ user.username|first|upper }}
                </div>
                <div style="flex: 1;">
                    <strong>{{ user.username }}</strong>
                    <div class="chat-preview" style="font-size: 12px; color: #666;">–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ</div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- –ü–†–ê–í–ê–Ø –ü–ê–ù–ï–õ–¨: –û–∫–Ω–æ —á–∞—Ç–∞ -->
    <div style="width: 70%; display: flex; flex-direction: column;">
        
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç–∞ -->
        <div id="chatHeader" style="padding: 15px; border-bottom: 1px solid #ddd; display: none;">
            <div style="display: flex; align-items: center;">
                <div style="width: 40px; height: 40px; background: #28a745; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 10px; font-weight: bold;" id="chatAvatar">
                    U
                </div>
                <div>
                    <h3 id="currentChatUser" style="margin: 0;"></h3>
                    <div id="chatStatus" style="font-size: 12px; color: #666;">–±—ã–ª(–∞) –Ω–µ–¥–∞–≤–Ω–æ</div>
                </div>
            </div>
        </div>
        
        <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
        <div id="messagesContainer" style="flex: 1; padding: 20px; overflow-y: auto; background: #f8f9fa; display: flex; flex-direction: column;">
            
            <!-- –ó–∞–≥–ª—É—à–∫–∞: –≤—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç -->
            <div id="noChatSelected" style="text-align: center; color: #666; margin: auto;">
                <div style="font-size: 48px; margin-bottom: 20px;">üí¨</div>
                <h3 style="margin-bottom: 10px;">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</h3>
                <p>–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Å–ø–∏—Å–∫–∞ —Å–ª–µ–≤–∞, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ</p>
            </div>
            
            <!-- –ó–¥–µ—Å—å –±—É–¥—É—Ç –ø–æ—è–≤–ª—è—Ç—å—Å—è —Å–æ–æ–±—â–µ–Ω–∏—è -->
            <div id="messages" style="display: none; flex: 1; overflow-y: auto;"></div>
        </div>
        
        <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ -->
        <div id="messageForm" style="padding: 15px; border-top: 1px solid #ddd; display: none;">
            <div style="display: flex;">
                <input type="text" 
                       id="messageInput" 
                       placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." 
                       style="flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 20px; margin-right: 10px; font-size: 14px;">
                <button id="sendButton" 
                        style="padding: 12px 24px; background: #007bff; color: white; border: none; border-radius: 20px; cursor: pointer; font-weight: bold;">
                    –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                </button>
            </div>
        </div>
    </div>
</div>

<!-- –°–∫—Ä—ã—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ -->
<div id="currentUserId" style="display: none;">{{ current_user.id }}</div>
<div id="currentUserName" style="display: none;">{{ current_user.username }}</div>

<script>
    // –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    let currentUserId = null;
    let currentUserName = null;
    let selectedUserId = null;
    let selectedUserName = null;
    let ws = null;
    let isAuthenticated = false;
    
    // –•—Ä–∞–Ω–∏–ª–∏—â–µ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ —á–∞—Ç–∞–º
    let chatMessages = {};
    
    // ========== –û–°–ù–û–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ó–ê–ì–†–£–ó–ö–ò ==========
    document.addEventListener('DOMContentLoaded', async function() {
        console.log('üöÄ –ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–∞...');
        
        // 1. –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å–∫—Ä—ã—Ç—ã—Ö –ø–æ–ª–µ–π (–æ—Ç —Å–µ—Ä–≤–µ—Ä–∞)
        const serverUserId = document.getElementById('currentUserId').textContent;
        const serverUserName = document.getElementById('currentUserName').textContent;
        
        if (serverUserId && serverUserName && serverUserId !== '0') {
            console.log('‚úÖ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', serverUserName);
            currentUserId = parseInt(serverUserId);
            currentUserName = serverUserName;
            isAuthenticated = true;
            
            // –ü–æ–¥–∫–ª—é—á–∞–µ–º WebSocket
            connectWebSocket();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä—ã —á–∞—Ç–æ–≤
            setTimeout(loadChatPreviews, 500);
        } else {
            // 2. –ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –Ω–µ –ø–µ—Ä–µ–¥–∞–ª –¥–∞–Ω–Ω—ã–µ, –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–∫–µ–Ω —á–µ—Ä–µ–∑ API
            console.log('‚ö†Ô∏è –î–∞–Ω–Ω—ã–µ –Ω–µ –ø–æ–ª—É—á–µ–Ω—ã –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞, –ø—Ä–æ–≤–µ—Ä—è–µ–º —á–µ—Ä–µ–∑ API...');
            await verifyAndLoadUser();
        }
        
        // –ù–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤—ã–±–æ—Ä–∞ —á–∞—Ç–∞
        setupChatSelection();
    });
    
    // ========== –ü–†–û–í–ï–†–ö–ê –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò –ß–ï–†–ï–ó API ==========
    async function verifyAndLoadUser() {
        try {
            // –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
            let token = localStorage.getItem('token');
            if (!token) {
                token = getCookie('token');
            }
            
            if (!token) {
                throw new Error('–¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω');
            }
            
            console.log('üîë –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–∫–µ–Ω —á–µ—Ä–µ–∑ API...');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–∫–µ–Ω —á–µ—Ä–µ–∑ —ç–Ω–¥–ø–æ–∏–Ω—Ç users/me
            const response = await fetch('/api/users/me', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (!response.ok) {
                throw new Error('–¢–æ–∫–µ–Ω –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω');
            }
            
            const userData = await response.json();
            console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω —á–µ—Ä–µ–∑ API:', userData.username);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
            currentUserId = userData.id;
            currentUserName = userData.username;
            isAuthenticated = true;
            
            document.getElementById('currentUserId').textContent = userData.id;
            document.getElementById('currentUserName').textContent = userData.username;
            document.getElementById('currentUserDisplay').textContent = userData.username;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            await loadUsersList();
            
            // –ü–æ–¥–∫–ª—é—á–∞–µ–º WebSocket
            connectWebSocket();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä—ã
            setTimeout(loadChatPreviews, 500);
            
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', error);
            alert('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.');
            window.location.href = '/login';
        }
    }
    
    // ========== –ó–ê–ì–†–£–ó–ö–ê –°–ü–ò–°–ö–ê –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô ==========
    async function loadUsersList() {
        try {
            const token = getToken();
            if (!token) return;
            
            const response = await fetch('/api/users/', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (response.ok) {
                const users = await response.json();
                updateUsersList(users);
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
        }
    }
    
    function updateUsersList(users) {
        const usersList = document.getElementById('usersList');
        
        // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —É–∂–µ –µ—Å—Ç—å –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ - –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º
        if (usersList.children.length > 0 && currentUserId) return;
        
        usersList.innerHTML = '';
        
        users.forEach(user => {
            if (user.id === currentUserId) return; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–µ–±—è
            
            const div = document.createElement('div');
            div.className = 'chat-item';
            div.dataset.userId = user.id;
            div.dataset.userName = user.username;
            div.style.padding = '12px 15px';
            div.style.borderBottom = '1px solid #f0f0f0';
            div.style.cursor = 'pointer';
            div.style.display = 'flex';
            div.style.alignItems = 'center';
            
            div.innerHTML = `
                <div style="width: 40px; height: 40px; background: #007bff; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 10px; font-weight: bold;">
                    ${user.username.charAt(0).toUpperCase()}
                </div>
                <div style="flex: 1;">
                    <strong>${user.username}</strong>
                    <div class="chat-preview" style="font-size: 12px; color: #666;">–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ</div>
                </div>
            `;
            
            // –ù–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
            div.addEventListener('click', function() {
                selectUser(user.id, user.username);
            });
            
            // –•–æ–≤–µ—Ä-—ç—Ñ—Ñ–µ–∫—Ç—ã
            div.addEventListener('mouseover', function() {
                if (!this.classList.contains('selected')) {
                    this.style.background = '#f5f5f5';
                }
            });
            
            div.addEventListener('mouseout', function() {
                if (!this.classList.contains('selected')) {
                    this.style.background = 'white';
                }
            });
            
            usersList.appendChild(div);
        });
    }
    
    // ========== –ù–ê–°–¢–†–û–ô–ö–ê –í–´–ë–û–†–ê –ß–ê–¢–û–í ==========
    function setupChatSelection() {
        // –î–ª—è —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ (–æ—Ç —Å–µ—Ä–≤–µ—Ä–∞)
        document.querySelectorAll('.chat-item').forEach(item => {
            item.addEventListener('click', function() {
                const userId = parseInt(this.dataset.userId);
                const userName = this.dataset.userName;
                selectUser(userId, userName);
            });
        });
    }
    
    // ========== –í–´–ë–û–† –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø –î–õ–Ø –ß–ê–¢–ê ==========
    function selectUser(userId, userName) {
        if (!isAuthenticated) {
            alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
            return;
        }
        
        selectedUserId = userId;
        selectedUserName = userName;
        
        // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —á–∞—Ç–∞
        document.querySelectorAll('.chat-item').forEach(i => {
            i.classList.remove('selected');
            i.style.background = 'white';
            i.style.borderLeft = 'none';
        });
        
        const selectedItem = document.querySelector(`.chat-item[data-user-id="${userId}"]`);
        if (selectedItem) {
            selectedItem.classList.add('selected');
            selectedItem.style.background = '#e3f2fd';
            selectedItem.style.borderLeft = '3px solid #007bff';
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç–∞
        document.getElementById('chatHeader').style.display = 'block';
        document.getElementById('currentChatUser').textContent = selectedUserName;
        document.getElementById('chatAvatar').textContent = selectedUserName.charAt(0).toUpperCase();
        
        // –°–∫—Ä—ã–≤–∞–µ–º –∑–∞–≥–ª—É—à–∫—É, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
        document.getElementById('noChatSelected').style.display = 'none';
        document.getElementById('messages').style.display = 'block';
        document.getElementById('messageForm').style.display = 'block';
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π
        loadChatHistory(selectedUserId);
        
        // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
        document.getElementById('messageInput').disabled = false;
        document.getElementById('sendButton').disabled = false;
        document.getElementById('messageInput').focus();
    }
    
    // ========== WEBSOCKET ==========
    function connectWebSocket() {
        if (!currentUserId) {
            console.error('‚ùå –ù–µ –º–æ–≥—É –ø–æ–¥–∫–ª—é—á–∏—Ç—å WebSocket: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω');
            return;
        }
        
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws/${currentUserId}`;
        
        console.log('üîó –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket:', wsUrl);
        ws = new WebSocket(wsUrl);
        
        ws.onopen = function() {
            console.log('‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω');
        };
        
        ws.onmessage = function(event) {
            try {
                const data = JSON.parse(event.data);
                console.log('üì© –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ:', data);
                
                if (data.error) {
                    console.error('–û—à–∏–±–∫–∞ WebSocket:', data.error);
                    return;
                }
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º ID —á–∞—Ç–∞
                let chatId = getChatId(data.sender_id, data.receiver_id);
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                if (!chatMessages[chatId]) {
                    chatMessages[chatId] = [];
                }
                chatMessages[chatId].push(data);
                
                // –ï—Å–ª–∏ —ç—Ç–æ –∞–∫—Ç–∏–≤–Ω—ã–π —á–∞—Ç - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                if (selectedUserId && (selectedUserId === data.sender_id || selectedUserId === data.receiver_id)) {
                    displayMessage(data);
                    scrollToBottom();
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
                updateChatPreview(chatId, data);
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
            }
        };
        
        ws.onerror = function(error) {
            console.error('‚ùå WebSocket –æ—à–∏–±–∫–∞:', error);
        };
        
        ws.onclose = function() {
            console.log('üîå WebSocket –æ—Ç–∫–ª—é—á–µ–Ω, –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã...');
            setTimeout(connectWebSocket, 3000);
        };
    }
    
    // ========== –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========
    function getChatId(user1, user2) {
        return [user1, user2].sort((a, b) => a - b).join('_');
    }
    
    async function loadChatHistory(otherUserId) {
        if (!otherUserId) return;
        
        const chatId = getChatId(currentUserId, otherUserId);
        
        // –û—á–∏—â–∞–µ–º —Ç–µ–∫—É—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        document.getElementById('messages').innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
        
        // –ï—Å–ª–∏ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
        if (chatMessages[chatId] && chatMessages[chatId].length > 0) {
            displayChatHistory(chatMessages[chatId]);
            return;
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å —Å–µ—Ä–≤–µ—Ä–∞
        try {
            const token = getToken();
            if (!token) {
                console.error('–¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return;
            }
            
            const response = await fetch(`/api/messages/with/${otherUserId}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (response.ok) {
                const messages = await response.json();
                chatMessages[chatId] = messages;
                displayChatHistory(messages);
                scrollToBottom();
            } else {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:', response.status);
                document.getElementById('messages').innerHTML = '<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏</div>';
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:', error);
        }
    }
    
    function displayChatHistory(messages) {
        const messagesDiv = document.getElementById('messages');
        messagesDiv.innerHTML = '';
        
        if (messages.length === 0) {
            messagesDiv.innerHTML = `
                <div style="text-align: center; color: #666; margin: auto;">
                    <div style="font-size: 32px; margin-bottom: 10px;">‚úâÔ∏è</div>
                    <p>–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ —Å ${selectedUserName}</p>
                    <p style="font-size: 12px;">–°–æ–æ–±—â–µ–Ω–∏—è –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å</p>
                </div>
            `;
            return;
        }
        
        messages.forEach(msg => {
            displayMessage(msg);
        });
    }
    
    function displayMessage(msg) {
        const messagesDiv = document.getElementById('messages');
        const isOwn = msg.sender_id === currentUserId;
        
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message';
        messageDiv.style.display = 'flex';
        messageDiv.style.marginBottom = '10px';
        messageDiv.style.justifyContent = isOwn ? 'flex-end' : 'flex-start';
        
        messageDiv.innerHTML = `
            <div style="max-width: 70%;">
                <div style="background: ${isOwn ? '#007bff' : 'white'}; 
                           color: ${isOwn ? 'white' : 'black'};
                           padding: 10px 15px;
                           border-radius: ${isOwn ? '15px 15px 0 15px' : '15px 15px 15px 0'};
                           border: ${isOwn ? 'none' : '1px solid #ddd'};
                           word-wrap: break-word;">
                    ${escapeHtml(msg.content)}
                </div>
                <div style="font-size: 11px; color: #666; text-align: ${isOwn ? 'right' : 'left'}; margin-top: 5px;">
                    ${formatTime(msg.timestamp)}
                </div>
            </div>
        `;
        
        messagesDiv.appendChild(messageDiv);
    }
    
    async function loadChatPreviews() {
        try {
            const token = getToken();
            if (!token) return;
            
            const response = await fetch('/api/messages/', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (response.ok) {
                const messages = await response.json();
                
                // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ —á–∞—Ç–∞–º
                messages.forEach(msg => {
                    const chatId = getChatId(msg.sender_id, msg.receiver_id);
                    const otherUserId = msg.sender_id === currentUserId ? msg.receiver_id : msg.sender_id;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
                    updateChatPreview(chatId, msg);
                });
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤:', error);
        }
    }
    
    function updateChatPreview(chatId, lastMessage) {
        const [user1, user2] = chatId.split('_').map(Number);
        const otherUserId = user1 === currentUserId ? user2 : user1;
        
        // –ù–∞—Ö–æ–¥–∏–º —ç–ª–µ–º–µ–Ω—Ç —á–∞—Ç–∞
        const chatItem = document.querySelector(`.chat-item[data-user-id="${otherUserId}"]`);
        if (chatItem) {
            const previewDiv = chatItem.querySelector('.chat-preview');
            if (previewDiv) {
                const content = escapeHtml(lastMessage.content);
                const shortContent = content.length > 30 
                    ? content.substring(0, 30) + '...' 
                    : content;
                previewDiv.textContent = shortContent;
                previewDiv.style.color = '#333';
                previewDiv.style.fontWeight = '500';
            }
        }
    }
    
    // ========== –û–¢–ü–†–ê–í–ö–ê –°–û–û–ë–©–ï–ù–ò–ô ==========
    document.getElementById('sendButton').addEventListener('click', sendMessage);
    document.getElementById('messageInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
    
    function sendMessage() {
        if (!isAuthenticated) {
            alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
            return;
        }
        
        const input = document.getElementById('messageInput');
        const message = input.value.trim();
        
        if (!message || !selectedUserId || !ws || ws.readyState !== WebSocket.OPEN) {
            if (!selectedUserId) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞');
                return;
            }
            if (ws.readyState !== WebSocket.OPEN) {
                alert('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ. –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è...');
                connectWebSocket();
                return;
            }
            return;
        }
        
        const messageData = {
            receiver_id: selectedUserId,
            content: message
        };
        
        ws.send(JSON.stringify(messageData));
        
        // –°—Ä–∞–∑—É –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ (–±—É–¥–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å—Å—è –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞)
        const tempMessage = {
            id: Date.now(),
            content: message,
            sender_id: currentUserId,
            receiver_id: selectedUserId,
            timestamp: new Date().toISOString(),
            is_read: false
        };
        displayMessage(tempMessage);
        scrollToBottom();
        
        // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
        input.value = '';
        input.focus();
    }
    
    // ========== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========
    function scrollToBottom() {
        const messagesDiv = document.getElementById('messages');
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
    
    function getToken() {
        // –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –∏–∑ localStorage
        let token = localStorage.getItem('token');
        
        // –ï—Å–ª–∏ –Ω–µ—Ç –≤ localStorage, –ø—Ä–æ–±—É–µ–º –∏–∑ –∫—É–∫–∏
        if (!token) {
            token = getCookie('token');
        }
        
        return token;
    }
    
    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
        return null;
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function formatTime(timestamp) {
        try {
            const date = new Date(timestamp);
            return date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        } catch (e) {
            return '--:--';
        }
    }
</script>

<style>
    .message {
        animation: fadeIn 0.3s;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    #messages {
        display: flex;
        flex-direction: column;
    }
    
    #messagesContainer {
        scroll-behavior: smooth;
    }
    
    .chat-item.selected {
        background-color: #e3f2fd !important;
        border-left: 3px solid #007bff !important;
    }
    
    .loading, .error {
        text-align: center;
        padding: 20px;
        color: #666;
    }
</style>
{% endblock %}