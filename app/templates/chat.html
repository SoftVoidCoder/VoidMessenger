{% extends "base.html" %}

{% block title %}–ß–∞—Ç - Void Messenger{% endblock %}

{% block content %}
<div style="display: flex; height: 90vh; font-family: Arial, sans-serif;">
    
    <!-- –õ–ï–í–ê–Ø –ü–ê–ù–ï–õ–¨: –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ -->
    <div style="width: 30%; border-right: 1px solid #ddd; display: flex; flex-direction: column;">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <div style="padding: 15px; border-bottom: 1px solid #ddd;">
            <h3 style="margin: 0;">–ß–∞—Ç—ã</h3>
            <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">
                –í—ã: <strong id="currentUserDisplay">{{ current_user.username }}</strong>
                <a href="/logout" style="margin-left: 10px; color: #666; font-size: 12px; text-decoration: none;">(–í—ã–π—Ç–∏)</a>
            </p>
        </div>
        
        <!-- –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
        <div id="usersList" style="flex: 1; overflow-y: auto;">
            {% for user in users %}
            <div class="chat-item" 
                 data-user-id="{{ user.id }}"
                 data-user-name="{{ user.username }}"
                 style="padding: 12px 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; display: flex; align-items: center;"
                 onmouseover="this.style.background='#f5f5f5'"
                 onmouseout="if(!this.classList.contains('selected')) this.style.background='white'">
                <div style="width: 40px; height: 40px; background: #007bff; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 10px; font-weight: bold;">
                    {{ user.username|first|upper }}
                </div>
                <div style="flex: 1;">
                    <strong>{{ user.username }}</strong>
                    <div class="chat-preview" style="font-size: 12px; color: #666;">–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ</div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- –ü–†–ê–í–ê–Ø –ü–ê–ù–ï–õ–¨: –û–∫–Ω–æ —á–∞—Ç–∞ -->
    <div style="width: 70%; display: flex; flex-direction: column;">
        
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç–∞ -->
        <div id="chatHeader" style="padding: 15px; border-bottom: 1px solid #ddd; display: none;">
            <div style="display: flex; align-items: center;">
                <div style="width: 40px; height: 40px; background: #28a745; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 10px; font-weight: bold;" id="chatAvatar">
                    U
                </div>
                <div>
                    <h3 id="currentChatUser" style="margin: 0;"></h3>
                    <div id="chatStatus" style="font-size: 12px; color: #666;">–±—ã–ª(–∞) –Ω–µ–¥–∞–≤–Ω–æ</div>
                </div>
            </div>
        </div>
        <div style="padding: 15px; border-bottom: 1px solid #ddd;">
    <h3 style="margin: 0;">–ß–∞—Ç—ã</h3>
    <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">
        –í—ã: <strong id="currentUserDisplay">–ó–∞–≥—Ä—É–∑–∫–∞...</strong>
        <a href="/logout" 
           onclick="localStorage.removeItem('token');" 
           style="margin-left: 10px; color: #f00; font-size: 12px; text-decoration: none;">
            (–í—ã–π—Ç–∏)
        </a>
    </p>
</div>
        
        <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
        <div id="messagesContainer" style="flex: 1; padding: 20px; overflow-y: auto; background: #f8f9fa; display: flex; flex-direction: column;">
            
            <!-- –ó–∞–≥–ª—É—à–∫–∞: –≤—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç -->
            <div id="noChatSelected" style="text-align: center; color: #666; margin: auto;">
                <div style="font-size: 48px; margin-bottom: 20px;">üí¨</div>
                <h3 style="margin-bottom: 10px;">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</h3>
                <p>–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Å–ø–∏—Å–∫–∞ —Å–ª–µ–≤–∞, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ</p>
            </div>
            
            <!-- –ó–¥–µ—Å—å –±—É–¥—É—Ç –ø–æ—è–≤–ª—è—Ç—å—Å—è —Å–æ–æ–±—â–µ–Ω–∏—è -->
            <div id="messages" style="display: none; flex: 1; overflow-y: auto;"></div>
        </div>
        
        <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ -->
        <div id="messageForm" style="padding: 15px; border-top: 1px solid #ddd; display: none;">
            <div style="display: flex;">
                <input type="text" 
                       id="messageInput" 
                       placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." 
                       style="flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 20px; margin-right: 10px; font-size: 14px;">
                <button id="sendButton" 
                        style="padding: 12px 24px; background: #007bff; color: white; border: none; border-radius: 20px; cursor: pointer; font-weight: bold;">
                    –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                </button>
            </div>
        </div>
    </div>
</div>

<!-- –°–∫—Ä—ã—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ -->
<div id="currentUserId" style="display: none;">{{ current_user.id }}</div>
<div id="currentUserName" style="display: none;">{{ current_user.username }}</div>

<!-- –í chat.html –∑–∞–º–µ–Ω–∏—Ç–µ –≤–µ—Å—å script –Ω–∞: -->
<script>
    // Telegram-style –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
    let currentUserId = null;
    let currentUserName = null;
    let selectedUserId = null;
    let selectedUserName = null;
    let ws = null;
    let chatMessages = {};
    
    // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞
    async function initApp() {
        console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —á–∞—Ç–∞...');
        
        // 1. –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
        let token = localStorage.getItem('token');
        
        // –ï—Å–ª–∏ –Ω–µ—Ç –≤ localStorage, –ø—Ä–æ–≤–µ—Ä—è–µ–º URL –ø–∞—Ä–∞–º–µ—Ç—Ä
        if (!token) {
            const urlParams = new URLSearchParams(window.location.search);
            token = urlParams.get('token');
            if (token) {
                localStorage.setItem('token', token);
                // –£–±–∏—Ä–∞–µ–º —Ç–æ–∫–µ–Ω –∏–∑ URL
                window.history.replaceState({}, document.title, "/chat");
            }
        }
        
        // 2. –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω–∞ –Ω–µ—Ç - —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ –ª–æ–≥–∏–Ω
        if (!token) {
            console.log('‚ùå –ù–µ—Ç —Ç–æ–∫–µ–Ω–∞, —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ –ª–æ–≥–∏–Ω');
            window.location.href = '/login';
            return;
        }
        
        // 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–∫–µ–Ω —á–µ—Ä–µ–∑ API
        try {
            const response = await fetch('/api/users/me', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (!response.ok) {
                throw new Error('–¢–æ–∫–µ–Ω –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω');
            }
            
            const userData = await response.json();
            console.log('‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω:', userData.username);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
            currentUserId = userData.id;
            currentUserName = userData.username;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            document.getElementById('currentUserDisplay').textContent = userData.username;
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            await loadUsersList(token);
            
            // –ü–æ–¥–∫–ª—é—á–∞–µ–º WebSocket
            connectWebSocket();
            
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', error);
            localStorage.removeItem('token');
            alert('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.');
            window.location.href = '/login';
        }
    }
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    async function loadUsersList(token) {
        try {
            const response = await fetch('/api/users/', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (response.ok) {
                const users = await response.json();
                updateUsersList(users);
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
        }
    }
    
    function updateUsersList(users) {
        const usersList = document.getElementById('usersList');
        usersList.innerHTML = '';
        
        users.forEach(user => {
            if (user.id === currentUserId) return;
            
            const div = document.createElement('div');
            div.className = 'chat-item';
            div.dataset.userId = user.id;
            div.dataset.userName = user.username;
            div.style.padding = '12px 15px';
            div.style.borderBottom = '1px solid #f0f0f0';
            div.style.cursor = 'pointer';
            div.style.display = 'flex';
            div.style.alignItems = 'center';
            
            div.innerHTML = `
                <div style="width: 40px; height: 40px; background: #007bff; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 10px; font-weight: bold;">
                    ${user.username.charAt(0).toUpperCase()}
                </div>
                <div style="flex: 1;">
                    <strong>${user.username}</strong>
                    <div class="chat-preview" style="font-size: 12px; color: #666;">–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ</div>
                </div>
            `;
            
            div.addEventListener('click', () => selectUser(user.id, user.username));
            div.addEventListener('mouseover', () => {
                if (!div.classList.contains('selected')) div.style.background = '#f5f5f5';
            });
            div.addEventListener('mouseout', () => {
                if (!div.classList.contains('selected')) div.style.background = 'white';
            });
            
            usersList.appendChild(div);
        });
    }
    
    // –í—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    function selectUser(userId, userName) {
        selectedUserId = userId;
        selectedUserName = userName;
        
        // –ü–æ–¥—Å–≤–µ—Ç–∫–∞
        document.querySelectorAll('.chat-item').forEach(item => {
            item.classList.remove('selected');
            item.style.background = 'white';
            item.style.borderLeft = 'none';
        });
        
        const selectedItem = document.querySelector(`.chat-item[data-user-id="${userId}"]`);
        if (selectedItem) {
            selectedItem.classList.add('selected');
            selectedItem.style.background = '#e3f2fd';
            selectedItem.style.borderLeft = '3px solid #007bff';
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á–∞—Ç
        document.getElementById('chatHeader').style.display = 'block';
        document.getElementById('currentChatUser').textContent = userName;
        document.getElementById('chatAvatar').textContent = userName.charAt(0).toUpperCase();
        document.getElementById('noChatSelected').style.display = 'none';
        document.getElementById('messages').style.display = 'block';
        document.getElementById('messageForm').style.display = 'block';
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é
        loadChatHistory(userId);
        document.getElementById('messageInput').focus();
    }
    
    // WebSocket
    function connectWebSocket() {
        if (!currentUserId) return;
        
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws/${currentUserId}`;
        
        console.log('üîó –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ WebSocket...');
        ws = new WebSocket(wsUrl);
        
        ws.onopen = () => console.log('‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω');
        
        ws.onmessage = (event) => {
            try {
                const data = JSON.parse(event.data);
                console.log('üì© –ü–æ–ª—É—á–µ–Ω–æ:', data);
                
                if (data.error) return;
                
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
                const chatId = [data.sender_id, data.receiver_id].sort((a,b) => a-b).join('_');
                if (!chatMessages[chatId]) chatMessages[chatId] = [];
                chatMessages[chatId].push(data);
                
                // –ï—Å–ª–∏ –∞–∫—Ç–∏–≤–Ω—ã–π —á–∞—Ç - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
                if (selectedUserId && (selectedUserId === data.sender_id || selectedUserId === data.receiver_id)) {
                    displayMessage(data);
                    scrollToBottom();
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–≤—å—é
                updateChatPreview(chatId, data);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏:', error);
            }
        };
        
        ws.onerror = (error) => console.error('‚ùå WebSocket –æ—à–∏–±–∫–∞:', error);
        ws.onclose = () => {
            console.log('üîå –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫...');
            setTimeout(connectWebSocket, 3000);
        };
    }
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏
    async function loadChatHistory(otherUserId) {
        const chatId = [currentUserId, otherUserId].sort((a,b) => a-b).join('_');
        
        document.getElementById('messages').innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
        
        if (chatMessages[chatId]?.length > 0) {
            displayChatHistory(chatMessages[chatId]);
            return;
        }
        
        try {
            const token = localStorage.getItem('token');
            const response = await fetch(`/api/messages/with/${otherUserId}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (response.ok) {
                const messages = await response.json();
                chatMessages[chatId] = messages;
                displayChatHistory(messages);
                scrollToBottom();
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:', error);
        }
    }
    
    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
    function displayChatHistory(messages) {
        const messagesDiv = document.getElementById('messages');
        messagesDiv.innerHTML = '';
        
        if (messages.length === 0) {
            messagesDiv.innerHTML = '<div style="text-align:center;color:#666;padding:20px;">–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ</div>';
            return;
        }
        
        messages.forEach(msg => displayMessage(msg));
    }
    
    function displayMessage(msg) {
        const messagesDiv = document.getElementById('messages');
        const isOwn = msg.sender_id === currentUserId;
        
        const messageDiv = document.createElement('div');
        messageDiv.style.display = 'flex';
        messageDiv.style.marginBottom = '10px';
        messageDiv.style.justifyContent = isOwn ? 'flex-end' : 'flex-start';
        
        messageDiv.innerHTML = `
            <div style="max-width: 70%;">
                <div style="background: ${isOwn ? '#007bff' : 'white'}; 
                           color: ${isOwn ? 'white' : 'black'};
                           padding: 10px 15px;
                           border-radius: ${isOwn ? '15px 15px 0 15px' : '15px 15px 15px 0'};
                           border: ${isOwn ? 'none' : '1px solid #ddd'};
                           word-wrap: break-word;">
                    ${escapeHtml(msg.content)}
                </div>
                <div style="font-size: 11px; color: #666; margin-top: 5px; text-align: ${isOwn ? 'right' : 'left'}">
                    ${new Date(msg.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                </div>
            </div>
        `;
        
        messagesDiv.appendChild(messageDiv);
    }
    
    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
    document.getElementById('sendButton').addEventListener('click', sendMessage);
    document.getElementById('messageInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
    
    function sendMessage() {
        const input = document.getElementById('messageInput');
        const message = input.value.trim();
        
        if (!message || !selectedUserId || !ws || ws.readyState !== 1) {
            if (!selectedUserId) alert('–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞');
            return;
        }
        
        ws.send(JSON.stringify({
            receiver_id: selectedUserId,
            content: message
        }));
        
        // –õ–æ–∫–∞–ª—å–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        displayMessage({
            id: Date.now(),
            content: message,
            sender_id: currentUserId,
            receiver_id: selectedUserId,
            timestamp: new Date().toISOString(),
            is_read: false
        });
        scrollToBottom();
        
        input.value = '';
        input.focus();
    }
    
    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function scrollToBottom() {
        const messagesDiv = document.getElementById('messages');
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
    
    function updateChatPreview(chatId, lastMessage) {
        const [id1, id2] = chatId.split('_').map(Number);
        const otherId = id1 === currentUserId ? id2 : id1;
        
        const item = document.querySelector(`.chat-item[data-user-id="${otherId}"]`);
        if (item) {
            const preview = item.querySelector('.chat-preview');
            if (preview) {
                preview.textContent = lastMessage.content.length > 30 
                    ? lastMessage.content.substring(0, 30) + '...' 
                    : lastMessage.content;
                preview.style.color = '#333';
            }
        }
    }
    
    // –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    document.addEventListener('DOMContentLoaded', initApp);
</script>

<style>
    .message {
        animation: fadeIn 0.3s;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    #messages {
        display: flex;
        flex-direction: column;
    }
    
    #messagesContainer {
        scroll-behavior: smooth;
    }
    
    .chat-item.selected {
        background-color: #e3f2fd !important;
        border-left: 3px solid #007bff !important;
    }
    
    .loading, .error {
        text-align: center;
        padding: 20px;
        color: #666;
    }
</style>
{% endblock %}