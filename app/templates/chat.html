{% extends "base.html" %}

{% block title %}–ß–∞—Ç - Void Messenger{% endblock %}

{% block content %}
<div style="display: flex; height: 90vh; font-family: Arial, sans-serif;">
    
    <!-- –õ–ï–í–ê–Ø –ü–ê–ù–ï–õ–¨: –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ (–∫–∞–∫ –≤ Telegram) -->
    <div style="width: 30%; border-right: 1px solid #ddd; display: flex; flex-direction: column;">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <div style="padding: 15px; border-bottom: 1px solid #ddd;">
            <h3 style="margin: 0;">–ß–∞—Ç—ã</h3>
            <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">
                –í—ã: <strong>{{ current_user.username }}</strong>
            </p>
        </div>
        
        <!-- –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
        <div id="usersList" style="flex: 1; overflow-y: auto;">
            {% for user in users %}
            <div class="chat-item" 
                 data-user-id="{{ user.id }}"
                 data-user-name="{{ user.username }}"
                 style="padding: 12px 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; display: flex; align-items: center;"
                 onmouseover="this.style.background='#f5f5f5'"
                 onmouseout="this.style.background='white'">
                <div style="width: 40px; height: 40px; background: #007bff; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 10px; font-weight: bold;">
                    {{ user.username|first|upper }}
                </div>
                <div>
                    <strong>{{ user.username }}</strong>
                    <div style="font-size: 12px; color: #666;">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è —á–∞—Ç–∞</div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- –ü–†–ê–í–ê–Ø –ü–ê–ù–ï–õ–¨: –û–∫–Ω–æ —á–∞—Ç–∞ -->
    <div style="width: 70%; display: flex; flex-direction: column;">
        
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç–∞ (–±—É–¥–µ—Ç –º–µ–Ω—è—Ç—å—Å—è) -->
        <div id="chatHeader" style="padding: 15px; border-bottom: 1px solid #ddd; display: none;">
            <div style="display: flex; align-items: center;">
                <div style="width: 40px; height: 40px; background: #28a745; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 10px; font-weight: bold;" id="chatAvatar">
                    U
                </div>
                <div>
                    <h3 id="currentChatUser" style="margin: 0;"></h3>
                    <div id="chatStatus" style="font-size: 12px; color: #666;">–±—ã–ª(–∞) –Ω–µ–¥–∞–≤–Ω–æ</div>
                </div>
            </div>
        </div>
        
        <!-- –°–æ–æ–±—â–µ–Ω–∏—è (–ø—É—Å—Ç–æ –ø–æ–∫–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω —á–∞—Ç) -->
        <div id="messagesContainer" style="flex: 1; padding: 20px; overflow-y: auto; background: #f8f9fa; display: flex; flex-direction: column;">
            
            <!-- –ó–∞–≥–ª—É—à–∫–∞: –≤—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç -->
            <div id="noChatSelected" style="text-align: center; color: #666; margin: auto;">
                <div style="font-size: 48px; margin-bottom: 20px;">üí¨</div>
                <h3 style="margin-bottom: 10px;">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</h3>
                <p>–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Å–ø–∏—Å–∫–∞ —Å–ª–µ–≤–∞, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ</p>
            </div>
            
            <!-- –ó–¥–µ—Å—å –±—É–¥—É—Ç –ø–æ—è–≤–ª—è—Ç—å—Å—è —Å–æ–æ–±—â–µ–Ω–∏—è -->
            <div id="messages" style="display: none;"></div>
        </div>
        
        <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ (—Å–∫—Ä—ã—Ç–æ –ø–æ–∫–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω —á–∞—Ç) -->
        <div id="messageForm" style="padding: 15px; border-top: 1px solid #ddd; display: none;">
            <div style="display: flex;">
                <input type="text" 
                       id="messageInput" 
                       placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." 
                       style="flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 20px; margin-right: 10px; font-size: 14px;">
                <button id="sendButton" 
                        style="padding: 12px 24px; background: #007bff; color: white; border: none; border-radius: 20px; cursor: pointer; font-weight: bold;">
                    –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                </button>
            </div>
        </div>
    </div>
</div>

<!-- –°–∫—Ä—ã—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ -->
<div id="currentUserId" style="display: none;">{{ current_user.id }}</div>
<div id="currentUserName" style="display: none;">{{ current_user.username }}</div>

<script>
    // –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    let currentUserId = parseInt(document.getElementById('currentUserId').textContent);
    let currentUserName = document.getElementById('currentUserName').textContent;
    let selectedUserId = null;
    let selectedUserName = null;
    let ws = null;
    
    // –•—Ä–∞–Ω–∏–ª–∏—â–µ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ —á–∞—Ç–∞–º
    let chatMessages = {};
    
    // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket
    function connectWebSocket() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws/${currentUserId}`;
        
        ws = new WebSocket(wsUrl);
        
        ws.onopen = function() {
            console.log('‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω');
        };
        
        ws.onmessage = function(event) {
            const data = JSON.parse(event.data);
            console.log('üì© –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ:', data);
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º ID —á–∞—Ç–∞ (–≤—Å–µ–≥–¥–∞ –º–µ–Ω—å—à–∏–π ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–µ—Ä–≤—ã–º)
            let chatId = getChatId(data.sender_id, data.receiver_id);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            if (!chatMessages[chatId]) {
                chatMessages[chatId] = [];
            }
            chatMessages[chatId].push(data);
            
            // –ï—Å–ª–∏ —ç—Ç–æ –∞–∫—Ç–∏–≤–Ω—ã–π —á–∞—Ç - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            if (selectedUserId === data.sender_id || selectedUserId === data.receiver_id) {
                displayMessage(data);
                scrollToBottom();
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Å–ø–∏—Å–∫–µ —á–∞—Ç–æ–≤
            updateChatPreview(chatId, data);
        };
        
        ws.onerror = function(error) {
            console.error('‚ùå WebSocket –æ—à–∏–±–∫–∞:', error);
        };
        
        ws.onclose = function() {
            console.log('üîå WebSocket –æ—Ç–∫–ª—é—á–µ–Ω, –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã...');
            setTimeout(connectWebSocket, 3000);
        };
    }
    
    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è ID —á–∞—Ç–∞ (–æ–¥–∏–Ω–∞–∫–æ–≤—ã–π –¥–ª—è –¥–≤—É—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
    function getChatId(user1, user2) {
        return [user1, user2].sort((a, b) => a - b).join('_');
    }
    
    // –í—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —á–∞—Ç–∞
    document.querySelectorAll('.chat-item').forEach(item => {
        item.addEventListener('click', function() {
            selectedUserId = parseInt(this.dataset.userId);
            selectedUserName = this.dataset.userName;
            
            // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —á–∞—Ç–∞
            document.querySelectorAll('.chat-item').forEach(i => {
                i.style.background = 'white';
            });
            this.style.background = '#e3f2fd';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç–∞
            document.getElementById('chatHeader').style.display = 'block';
            document.getElementById('currentChatUser').textContent = selectedUserName;
            document.getElementById('chatAvatar').textContent = selectedUserName.charAt(0).toUpperCase();
            
            // –°–∫—Ä—ã–≤–∞–µ–º –∑–∞–≥–ª—É—à–∫—É, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
            document.getElementById('noChatSelected').style.display = 'none';
            document.getElementById('messages').style.display = 'block';
            document.getElementById('messageForm').style.display = 'block';
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π
            loadChatHistory(selectedUserId);
            
            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
            document.getElementById('messageInput').disabled = false;
            document.getElementById('sendButton').disabled = false;
            document.getElementById('messageInput').focus();
        });
    });
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞
    async function loadChatHistory(otherUserId) {
        const chatId = getChatId(currentUserId, otherUserId);
        
        // –ï—Å–ª–∏ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
        if (chatMessages[chatId] && chatMessages[chatId].length > 0) {
            displayChatHistory(chatMessages[chatId]);
            return;
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å —Å–µ—Ä–≤–µ—Ä–∞
        try {
            const token = localStorage.getItem('token') || getCookie('token');
            const response = await fetch(`/api/messages/with/${otherUserId}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (response.ok) {
                const messages = await response.json();
                chatMessages[chatId] = messages;
                displayChatHistory(messages);
                scrollToBottom();
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:', error);
        }
    }
    
    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞
    function displayChatHistory(messages) {
        const messagesDiv = document.getElementById('messages');
        messagesDiv.innerHTML = '';
        
        messages.forEach(msg => {
            displayMessage(msg);
        });
    }
    
    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ–¥–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
    function displayMessage(msg) {
        const messagesDiv = document.getElementById('messages');
        const isOwn = msg.sender_id === currentUserId;
        
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message';
        messageDiv.style.display = 'flex';
        messageDiv.style.marginBottom = '10px';
        messageDiv.style.justifyContent = isOwn ? 'flex-end' : 'flex-start';
        
        messageDiv.innerHTML = `
            <div style="max-width: 70%;">
                <div style="background: ${isOwn ? '#007bff' : 'white'}; 
                           color: ${isOwn ? 'white' : 'black'};
                           padding: 10px 15px;
                           border-radius: ${isOwn ? '15px 15px 0 15px' : '15px 15px 15px 0'};
                           border: ${isOwn ? 'none' : '1px solid #ddd'};
                           word-wrap: break-word;">
                    ${msg.content}
                </div>
                <div style="font-size: 11px; color: #666; text-align: ${isOwn ? 'right' : 'left'}; margin-top: 5px;">
                    ${new Date(msg.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                </div>
            </div>
        `;
        
        messagesDiv.appendChild(messageDiv);
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–≤—å—é —á–∞—Ç–∞ –≤ —Å–ø–∏—Å–∫–µ
    function updateChatPreview(chatId, lastMessage) {
        const [user1, user2] = chatId.split('_').map(Number);
        const otherUserId = user1 === currentUserId ? user2 : user1;
        
        // –ù–∞—Ö–æ–¥–∏–º —ç–ª–µ–º–µ–Ω—Ç —á–∞—Ç–∞
        const chatItem = document.querySelector(`.chat-item[data-user-id="${otherUserId}"]`);
        if (chatItem) {
            const previewDiv = chatItem.querySelector('.chat-preview') || (() => {
                const div = document.createElement('div');
                div.className = 'chat-preview';
                div.style.fontSize = '12px';
                div.style.color = '#666';
                chatItem.querySelector('div').appendChild(div);
                return div;
            })();
            
            const preview = previewDiv;
            preview.textContent = lastMessage.content.length > 30 
                ? lastMessage.content.substring(0, 30) + '...' 
                : lastMessage.content;
            preview.style.color = '#333';
        }
    }
    
    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
    document.getElementById('sendButton').addEventListener('click', sendMessage);
    document.getElementById('messageInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') sendMessage();
    });
    
    function sendMessage() {
        const input = document.getElementById('messageInput');
        const message = input.value.trim();
        
        if (!message || !selectedUserId || !ws) return;
        
        const messageData = {
            receiver_id: selectedUserId,
            content: message
        };
        
        ws.send(JSON.stringify(messageData));
        
        // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
        input.value = '';
        input.focus();
    }
    
    // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
    function scrollToBottom() {
        const messagesDiv = document.getElementById('messages');
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
    
    // –ü–æ–ª—É—á–µ–Ω–∏–µ cookie (–¥–ª—è —Ç–æ–∫–µ–Ω–∞)
    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
    }
    
    // –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    document.addEventListener('DOMContentLoaded', function() {
        connectWebSocket();
    });
</script>

<style>
    .message {
        animation: fadeIn 0.3s;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    #messages {
        display: flex;
        flex-direction: column;
    }
    
    #messagesContainer {
        scroll-behavior: smooth;
    }
</style>
{% endblock %}