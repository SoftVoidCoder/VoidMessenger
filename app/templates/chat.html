{% extends "base.html" %}

{% block title %}–ß–∞—Ç - Void Messenger{% endblock %}

{% block content %}
<div style="display: flex; height: 90vh; font-family: Arial, sans-serif;">
    
    <!-- –õ–ï–í–ê–Ø –ü–ê–ù–ï–õ–¨: –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ (–∫–∞–∫ –≤ Telegram) -->
    <div style="width: 30%; border-right: 1px solid #ddd; display: flex; flex-direction: column;">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <div style="padding: 15px; border-bottom: 1px solid #ddd;">
            <h3 style="margin: 0;">–ß–∞—Ç—ã</h3>
            <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">
                –í—ã: <strong>{{ current_user.username }}</strong>
                <a href="/logout" style="margin-left: 10px; color: #666; font-size: 12px;">(–í—ã–π—Ç–∏)</a>
            </p>
        </div>
        
        <!-- –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
        <div id="usersList" style="flex: 1; overflow-y: auto;">
            {% for user in users %}
            <div class="chat-item" 
                 data-user-id="{{ user.id }}"
                 data-user-name="{{ user.username }}"
                 style="padding: 12px 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; display: flex; align-items: center;"
                 onmouseover="this.style.background='#f5f5f5'"
                 onmouseout="this.style.background='white'">
                <div style="width: 40px; height: 40px; background: #007bff; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 10px; font-weight: bold;">
                    {{ user.username|first|upper }}
                </div>
                <div style="flex: 1;">
                    <strong>{{ user.username }}</strong>
                    <div class="chat-preview" style="font-size: 12px; color: #666;">–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ</div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- –ü–†–ê–í–ê–Ø –ü–ê–ù–ï–õ–¨: –û–∫–Ω–æ —á–∞—Ç–∞ -->
    <div style="width: 70%; display: flex; flex-direction: column;">
        
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç–∞ (–±—É–¥–µ—Ç –º–µ–Ω—è—Ç—å—Å—è) -->
        <div id="chatHeader" style="padding: 15px; border-bottom: 1px solid #ddd; display: none;">
            <div style="display: flex; align-items: center;">
                <div style="width: 40px; height: 40px; background: #28a745; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 10px; font-weight: bold;" id="chatAvatar">
                    U
                </div>
                <div>
                    <h3 id="currentChatUser" style="margin: 0;"></h3>
                    <div id="chatStatus" style="font-size: 12px; color: #666;">–±—ã–ª(–∞) –Ω–µ–¥–∞–≤–Ω–æ</div>
                </div>
            </div>
        </div>
        
        <!-- –°–æ–æ–±—â–µ–Ω–∏—è (–ø—É—Å—Ç–æ –ø–æ–∫–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω —á–∞—Ç) -->
        <div id="messagesContainer" style="flex: 1; padding: 20px; overflow-y: auto; background: #f8f9fa; display: flex; flex-direction: column;">
            
            <!-- –ó–∞–≥–ª—É—à–∫–∞: –≤—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç -->
            <div id="noChatSelected" style="text-align: center; color: #666; margin: auto;">
                <div style="font-size: 48px; margin-bottom: 20px;">üí¨</div>
                <h3 style="margin-bottom: 10px;">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</h3>
                <p>–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Å–ø–∏—Å–∫–∞ —Å–ª–µ–≤–∞, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ</p>
            </div>
            
            <!-- –ó–¥–µ—Å—å –±—É–¥—É—Ç –ø–æ—è–≤–ª—è—Ç—å—Å—è —Å–æ–æ–±—â–µ–Ω–∏—è -->
            <div id="messages" style="display: none; flex: 1; overflow-y: auto;"></div>
        </div>
        
        <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ (—Å–∫—Ä—ã—Ç–æ –ø–æ–∫–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω —á–∞—Ç) -->
        <div id="messageForm" style="padding: 15px; border-top: 1px solid #ddd; display: none;">
            <div style="display: flex;">
                <input type="text" 
                       id="messageInput" 
                       placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." 
                       style="flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 20px; margin-right: 10px; font-size: 14px;">
                <button id="sendButton" 
                        style="padding: 12px 24px; background: #007bff; color: white; border: none; border-radius: 20px; cursor: pointer; font-weight: bold;">
                    –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                </button>
            </div>
        </div>
    </div>
</div>

<!-- –°–∫—Ä—ã—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ -->
<div id="currentUserId" style="display: none;">{{ current_user.id }}</div>
<div id="currentUserName" style="display: none;">{{ current_user.username }}</div>

<script>
    // –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    let currentUserId = parseInt(document.getElementById('currentUserId').textContent);
    let currentUserName = document.getElementById('currentUserName').textContent;
    let selectedUserId = null;
    let selectedUserName = null;
    let ws = null;
    
    // –•—Ä–∞–Ω–∏–ª–∏—â–µ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ —á–∞—Ç–∞–º
    let chatMessages = {};
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    document.addEventListener('DOMContentLoaded', async function() {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ —Ç–æ–∫–µ–Ω
        const token = getToken();
        
        if (!token) {
            // –ï—Å–ª–∏ –Ω–µ—Ç —Ç–æ–∫–µ–Ω–∞, —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ –ª–æ–≥–∏–Ω
            alert('–í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã. –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ö–æ–¥–∞...');
            window.location.href = '/login';
            return;
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å —Ç–æ–∫–µ–Ω–∞
        try {
            const response = await fetch('/api/users/me', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (!response.ok) {
                throw new Error('–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
            }
            
            // –£—Å–ø–µ—à–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã - –ø–æ–¥–∫–ª—é—á–∞–µ–º WebSocket
            console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω:', currentUserName);
            connectWebSocket();
            
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', error);
            alert('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.');
            window.location.href = '/login';
        }
    });
    
    // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket
    function connectWebSocket() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws/${currentUserId}`;
        
        console.log('üîó –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket:', wsUrl);
        ws = new WebSocket(wsUrl);
        
        ws.onopen = function() {
            console.log('‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω');
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —á–∞—Ç–æ–≤ –ø–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
            loadChatPreviews();
        };
        
        ws.onmessage = function(event) {
            try {
                const data = JSON.parse(event.data);
                console.log('üì© –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ:', data);
                
                if (data.error) {
                    console.error('–û—à–∏–±–∫–∞ WebSocket:', data.error);
                    return;
                }
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º ID —á–∞—Ç–∞ (–≤—Å–µ–≥–¥–∞ –º–µ–Ω—å—à–∏–π ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–µ—Ä–≤—ã–º)
                let chatId = getChatId(data.sender_id, data.receiver_id);
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                if (!chatMessages[chatId]) {
                    chatMessages[chatId] = [];
                }
                chatMessages[chatId].push(data);
                
                // –ï—Å–ª–∏ —ç—Ç–æ –∞–∫—Ç–∏–≤–Ω—ã–π —á–∞—Ç - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                if (selectedUserId && (selectedUserId === data.sender_id || selectedUserId === data.receiver_id)) {
                    displayMessage(data);
                    scrollToBottom();
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Å–ø–∏—Å–∫–µ —á–∞—Ç–æ–≤
                updateChatPreview(chatId, data);
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
            }
        };
        
        ws.onerror = function(error) {
            console.error('‚ùå WebSocket –æ—à–∏–±–∫–∞:', error);
        };
        
        ws.onclose = function() {
            console.log('üîå WebSocket –æ—Ç–∫–ª—é—á–µ–Ω, –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥...');
            setTimeout(connectWebSocket, 5000);
        };
    }
    
    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è ID —á–∞—Ç–∞ (–æ–¥–∏–Ω–∞–∫–æ–≤—ã–π –¥–ª—è –¥–≤—É—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
    function getChatId(user1, user2) {
        return [user1, user2].sort((a, b) => a - b).join('_');
    }
    
    // –í—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —á–∞—Ç–∞
    document.querySelectorAll('.chat-item').forEach(item => {
        item.addEventListener('click', function() {
            selectedUserId = parseInt(this.dataset.userId);
            selectedUserName = this.dataset.userName;
            
            // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —á–∞—Ç–∞
            document.querySelectorAll('.chat-item').forEach(i => {
                i.style.background = 'white';
                i.style.borderLeft = 'none';
            });
            this.style.background = '#e3f2fd';
            this.style.borderLeft = '3px solid #007bff';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç–∞
            document.getElementById('chatHeader').style.display = 'block';
            document.getElementById('currentChatUser').textContent = selectedUserName;
            document.getElementById('chatAvatar').textContent = selectedUserName.charAt(0).toUpperCase();
            
            // –°–∫—Ä—ã–≤–∞–µ–º –∑–∞–≥–ª—É—à–∫—É, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
            document.getElementById('noChatSelected').style.display = 'none';
            document.getElementById('messages').style.display = 'block';
            document.getElementById('messageForm').style.display = 'block';
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π
            loadChatHistory(selectedUserId);
            
            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
            document.getElementById('messageInput').disabled = false;
            document.getElementById('sendButton').disabled = false;
            document.getElementById('messageInput').focus();
        });
    });
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞
    async function loadChatHistory(otherUserId) {
        const chatId = getChatId(currentUserId, otherUserId);
        
        // –û—á–∏—â–∞–µ–º —Ç–µ–∫—É—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        document.getElementById('messages').innerHTML = '';
        
        // –ï—Å–ª–∏ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
        if (chatMessages[chatId] && chatMessages[chatId].length > 0) {
            displayChatHistory(chatMessages[chatId]);
            return;
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å —Å–µ—Ä–≤–µ—Ä–∞
        try {
            const token = getToken();
            if (!token) {
                console.error('–¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return;
            }
            
            const response = await fetch(`/api/messages/with/${otherUserId}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (response.ok) {
                const messages = await response.json();
                chatMessages[chatId] = messages;
                displayChatHistory(messages);
                scrollToBottom();
            } else {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:', response.status);
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:', error);
        }
    }
    
    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞
    function displayChatHistory(messages) {
        const messagesDiv = document.getElementById('messages');
        
        if (messages.length === 0) {
            messagesDiv.innerHTML = `
                <div style="text-align: center; color: #666; margin: auto;">
                    <div style="font-size: 32px; margin-bottom: 10px;">‚úâÔ∏è</div>
                    <p>–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ —Å ${selectedUserName}</p>
                    <p style="font-size: 12px;">–°–æ–æ–±—â–µ–Ω–∏—è –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å</p>
                </div>
            `;
            return;
        }
        
        messages.forEach(msg => {
            displayMessage(msg);
        });
    }
    
    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ–¥–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
    function displayMessage(msg) {
        const messagesDiv = document.getElementById('messages');
        const isOwn = msg.sender_id === currentUserId;
        
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message';
        messageDiv.style.display = 'flex';
        messageDiv.style.marginBottom = '10px';
        messageDiv.style.justifyContent = isOwn ? 'flex-end' : 'flex-start';
        
        messageDiv.innerHTML = `
            <div style="max-width: 70%;">
                <div style="background: ${isOwn ? '#007bff' : 'white'}; 
                           color: ${isOwn ? 'white' : 'black'};
                           padding: 10px 15px;
                           border-radius: ${isOwn ? '15px 15px 0 15px' : '15px 15px 15px 0'};
                           border: ${isOwn ? 'none' : '1px solid #ddd'};
                           word-wrap: break-word;">
                    ${escapeHtml(msg.content)}
                </div>
                <div style="font-size: 11px; color: #666; text-align: ${isOwn ? 'right' : 'left'}; margin-top: 5px;">
                    ${formatTime(msg.timestamp)}
                </div>
            </div>
        `;
        
        messagesDiv.appendChild(messageDiv);
    }
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ —á–∞—Ç–æ–≤
    async function loadChatPreviews() {
        try {
            const token = getToken();
            if (!token) return;
            
            const response = await fetch('/api/messages/', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (response.ok) {
                const messages = await response.json();
                
                // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ —á–∞—Ç–∞–º
                messages.forEach(msg => {
                    const chatId = getChatId(msg.sender_id, msg.receiver_id);
                    const otherUserId = msg.sender_id === currentUserId ? msg.receiver_id : msg.sender_id;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
                    updateChatPreview(chatId, msg);
                });
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤:', error);
        }
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–≤—å—é —á–∞—Ç–∞ –≤ —Å–ø–∏—Å–∫–µ
    function updateChatPreview(chatId, lastMessage) {
        const [user1, user2] = chatId.split('_').map(Number);
        const otherUserId = user1 === currentUserId ? user2 : user1;
        
        // –ù–∞—Ö–æ–¥–∏–º —ç–ª–µ–º–µ–Ω—Ç —á–∞—Ç–∞
        const chatItem = document.querySelector(`.chat-item[data-user-id="${otherUserId}"]`);
        if (chatItem) {
            const previewDiv = chatItem.querySelector('.chat-preview');
            if (previewDiv) {
                const content = lastMessage.content.length > 30 
                    ? lastMessage.content.substring(0, 30) + '...' 
                    : lastMessage.content;
                previewDiv.textContent = content;
                previewDiv.style.color = '#333';
                previewDiv.style.fontWeight = '500';
                
                // –î–æ–±–∞–≤–ª—è–µ–º –≤—Ä–µ–º—è
                const timeSpan = previewDiv.querySelector('.last-time') || (() => {
                    const span = document.createElement('span');
                    span.className = 'last-time';
                    span.style.float = 'right';
                    span.style.fontSize = '10px';
                    span.style.color = '#888';
                    previewDiv.appendChild(span);
                    return span;
                })();
                
                timeSpan.textContent = formatTimeShort(lastMessage.timestamp);
            }
        }
    }
    
    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
    document.getElementById('sendButton').addEventListener('click', sendMessage);
    document.getElementById('messageInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
    
    function sendMessage() {
        const input = document.getElementById('messageInput');
        const message = input.value.trim();
        
        if (!message || !selectedUserId || !ws || ws.readyState !== WebSocket.OPEN) {
            console.error('–ù–µ–ª—å–∑—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ:', {
                message: message,
                selectedUserId: selectedUserId,
                wsReady: ws ? ws.readyState : 'no ws'
            });
            
            if (ws.readyState !== WebSocket.OPEN) {
                alert('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ. –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è...');
                connectWebSocket();
            }
            return;
        }
        
        const messageData = {
            receiver_id: selectedUserId,
            content: message
        };
        
        ws.send(JSON.stringify(messageData));
        
        // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
        input.value = '';
        input.focus();
    }
    
    // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
    function scrollToBottom() {
        const messagesDiv = document.getElementById('messages');
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
    
    // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞
    function getToken() {
        // –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –∏–∑ localStorage
        let token = localStorage.getItem('token');
        
        // –ï—Å–ª–∏ –Ω–µ—Ç –≤ localStorage, –ø—Ä–æ–±—É–µ–º –∏–∑ –∫—É–∫–∏
        if (!token) {
            token = getCookie('token');
            if (token) {
                localStorage.setItem('token', token);
            }
        }
        
        return token;
    }
    
    // –ü–æ–ª—É—á–µ–Ω–∏–µ cookie
    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
        return null;
    }
    
    // –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
    function formatTime(timestamp) {
        const date = new Date(timestamp);
        return date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    }
    
    function formatTimeShort(timestamp) {
        const date = new Date(timestamp);
        const now = new Date();
        const diff = now - date;
        
        if (diff < 24 * 60 * 60 * 1000) {
            // –°–µ–≥–æ–¥–Ω—è
            return date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        } else if (diff < 7 * 24 * 60 * 60 * 1000) {
            // –ù–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ
            return date.toLocaleDateString([], {weekday: 'short'});
        } else {
            // –†–∞–Ω–µ–µ
            return date.toLocaleDateString([], {month: 'short', day: 'numeric'});
        }
    }
</script>

<style>
    .message {
        animation: fadeIn 0.3s;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    #messages {
        display: flex;
        flex-direction: column;
    }
    
    #messagesContainer {
        scroll-behavior: smooth;
    }
    
    .chat-item:hover {
        background-color: #f5f5f5 !important;
    }
    
    .chat-item.selected {
        background-color: #e3f2fd !important;
        border-left: 3px solid #007bff !important;
    }
</style>
{% endblock %}